import sys
import json
import re
import os

from autoparallel.BE.SlotRouting import addAllAnchors
from autoparallel.BE.Utilities import getSlotsInSLRIndex

SLR_NUM = 4
RW_SETUP_PATH = '~/rapidwright/rapidwright_06_29/rapidwright.sh'


def getVivadoScriptForSLR(slr_index):

  script = []

  # this will be generated by RW after the stitching
  script.append(f'source -notrace {slr_stitch_dir}/slr_{slr_index}/slr_{slr_index}_load.tcl')

  # to verify the tap of row buffers
  script.append(f'puts [get_property ROUTE [get_nets ap_clk]]')
  script.append(f'report_timing_summary')

  script.append(f'delete_pblocks *')

  # unroute the laguna nets that cause conflict
  script.append(f'route_design -unroute -nets [get_nets -hierarchical -filter {{ ROUTE_STATUS == "CONFLICTS" }}]')

  # relax the clock 
  script.append(f'create_clock -name ap_clk -period 3 [get_pins test_bufg/O]')
  script.append(f'set_clock_uncertainty -hold 0.02 [get_clocks ap_clk]')

  script.append(f'write_checkpoint slr_{slr_index}_before_routed.dcp')

  # add back the placeholder FFs
  script += addAllAnchors(hub, base_dir, getSlotsInSLRIndex(hub, slr_index))

  script.append(f'route_design -preserve')

  script.append(f'write_checkpoint {slr_stitch_dir}/slr_{slr_index}/checkpoint/slr_{slr_index}_routed.dcp')
  script.append(f'write_edif {slr_stitch_dir}/slr_{slr_index}/checkpoint/slr_{slr_index}_routed.edf')

  return script


def getParallelTasks():
  all_tasks = []
  for slr_index in range(SLR_NUM):
    slots = getSlotsInSLRIndex(hub, slr_index)

    cd = f'cd {slr_stitch_dir}/slr_{slr_index}'
    rw_source = f'source {RW_SETUP_PATH}'
    get_dcp_regexp = lambda slot_name: f'(.*{slot_name}.*phys_opt.*dcp)'
    all_dcp_regexps = '|'.join([get_dcp_regexp(slot_name) for slot_name in slots])
    rw = f'java com.xilinx.rapidwright.examples.MergeDCP {slot_routing_dir} slr_{slr_index}.dcp "{all_dcp_regexps}"'

    vivado = f'VIV_VER={VIV_VER} vivado -mode batch -source {slr_stitch_dir}/slr_{slr_index}/route_slr_{slr_index}.tcl'

    stitch = f'{cd} && {rw_source} && {rw} && {vivado}'

    all_tasks.append(stitch)

  open(f'{slr_stitch_dir}/parallel-route-slr.txt', 'w').write('\n'.join(all_tasks))


if __name__ == '__main__':
  assert len(sys.argv) == 4, 'input (1) the path to the front end result file and (2) the target directory'
  hub_path = sys.argv[1]
  base_dir = sys.argv[2]
  VIV_VER=sys.argv[3]

  hub = json.loads(open(hub_path, 'r').read())

  slr_stitch_dir = f'{base_dir}/SLR_level_stitch'
  os.mkdir(slr_stitch_dir)

  slot_routing_dir = f'{base_dir}/slot_routing'

  for slr_index in range(SLR_NUM):
    os.mkdir(f'{slr_stitch_dir}/slr_{slr_index}')
    os.mkdir(f'{slr_stitch_dir}/slr_{slr_index}/checkpoint')

  for slr_index in range(SLR_NUM):
    script = getVivadoScriptForSLR(slr_index)

    open(f'{slr_stitch_dir}/slr_{slr_index}/route_slr_{slr_index}.tcl', 'w').write('\n'.join(script))

  getParallelTasks()